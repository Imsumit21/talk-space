---
phase: 02-authentication-lobby-redesign
plan: 03
type: execute
wave: 3
depends_on: ["02-02"]
files_modified:
  - client/src/components/Lobby.tsx
  - client/src/animations/transitions.ts
  - client/src/App.tsx
autonomous: true

must_haves:
  truths:
    - "User sees polished lobby with gradient avatar circle, username display, tagline, and live online count badge"
    - "User sees prominent Enter Space button with gradient styling and hover effects"
    - "User experiences fade/scale transition from auth page to lobby"
    - "User experiences zoom-in transition from lobby to game space"
    - "User sees skeleton loading screen during session restore instead of plain Loading text"
  artifacts:
    - path: "client/src/components/Lobby.tsx"
      provides: "Polished lobby component with glassmorphism styling"
      exports: ["Lobby"]
    - path: "client/src/animations/transitions.ts"
      provides: "Framer Motion page transition variants"
      exports: ["fadeScaleVariants", "zoomInVariants"]
    - path: "client/src/App.tsx"
      provides: "App shell with AnimatePresence page transitions and skeleton loading"
      min_lines: 80
  key_links:
    - from: "client/src/App.tsx"
      to: "framer-motion"
      via: "AnimatePresence wrapping page views"
      pattern: "AnimatePresence"
    - from: "client/src/App.tsx"
      to: "client/src/animations/transitions.ts"
      via: "fadeScaleVariants and zoomInVariants imported for motion.div"
      pattern: "fadeScaleVariants|zoomInVariants"
    - from: "client/src/components/Lobby.tsx"
      to: "client/src/store/useGameStore.ts"
      via: "Reading authUser for username and avatar display"
      pattern: "useGameStore"
    - from: "client/src/components/Lobby.tsx"
      to: "client/src/services/socket.ts"
      via: "Socket.io for live online count"
      pattern: "socket"
    - from: "client/src/App.tsx"
      to: "client/src/components/Lobby.tsx"
      via: "Renders Lobby when authenticated but not joined"
      pattern: "Lobby"
---

<objective>
Create the polished Lobby component, define framer-motion transition variants, and rewrite App.tsx with AnimatePresence page transitions and skeleton loading for session restore.

Purpose: Complete the cinematic user journey from auth to lobby to game space with smooth animated transitions at every step, and replace the plain loading text with proper skeleton UI.

Output: Lobby.tsx as standalone component, transitions.ts with reusable motion variants, and App.tsx rewritten with AnimatePresence wrapping all page views.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-authentication-lobby-redesign/02-01-SUMMARY.md
@.planning/phases/02-authentication-lobby-redesign/02-02-SUMMARY.md
@client/src/App.tsx
@client/src/components/Lobby.tsx
@client/src/store/useGameStore.ts
@client/src/services/socket.ts
@client/src/services/auth.ts
@client/src/components/ui/Card.tsx
@client/src/components/ui/Badge.tsx
@client/src/components/ui/Button.tsx
@client/src/components/ui/Toast.tsx
@client/src/components/GradientBackground.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create transition variants and polished Lobby component</name>
  <files>client/src/animations/transitions.ts, client/src/components/Lobby.tsx</files>
  <action>
1. Create `client/src/animations/transitions.ts`:

   Import Variants type from framer-motion.

   **fadeScaleVariants** (auth <-> lobby transition):
   ```ts
   export const fadeScaleVariants: Variants = {
     initial: { opacity: 0, scale: 0.95 },
     animate: { opacity: 1, scale: 1, transition: { duration: 0.3, ease: 'easeOut' } },
     exit: { opacity: 0, scale: 1.05, transition: { duration: 0.2, ease: 'easeIn' } },
   };
   ```

   **zoomInVariants** (lobby -> game space transition):
   ```ts
   export const zoomInVariants: Variants = {
     initial: { opacity: 0, scale: 0.8 },
     animate: { opacity: 1, scale: 1, transition: { duration: 0.4, ease: 'easeOut' } },
     exit: { opacity: 0, scale: 1.2, transition: { duration: 0.3, ease: 'easeIn' } },
   };
   ```

2. Create `client/src/components/Lobby.tsx` as a standalone component (extract from App.tsx):

   **Imports:** Card, Button, Badge from ui/, GradientBackground, useGameStore, socket service, logout from auth service, useState/useEffect/useCallback from react.

   **Layout:**
   - GradientBackground behind everything (same as auth page for visual continuity)
   - Centered content with flex items-center justify-center min-h-screen
   - Card variant="glass" with p-8 max-w-sm

   **Content:**
   a. **Gradient Avatar Circle:**
      - 80x80px circular div with gradient background (from-primary-500 to-accent-500)
      - Display first letter of username in white, text-3xl, font-bold, centered
      - Rounded-full with ring-4 ring-primary-500/20
      - Centered above the card content

   b. **Username Display:**
      - "Welcome back," text in text-gray-400 text-sm
      - Username in text-white text-xl font-heading font-semibold
      - Centered below avatar

   c. **Tagline:**
      - "Ready to explore?" in text-gray-500 text-sm italic

   d. **Live Online Count Badge:**
      - Badge variant="voice" with pulse indicator
      - Display "{count} online" text
      - Get count from Socket.io: emit 'getOnlineCount' on mount, listen for 'onlineCount' event
      - Cleanup listener on unmount
      - If socket is not connected, don't emit (show "-- online" as placeholder)

   e. **Enter Space Button:**
      - Gradient button matching auth page style: bg-gradient-to-r from-primary-500 to-accent-500
      - Full width, large size (py-3 text-lg)
      - Hover: scale-[1.02], shadow-glow-md
      - Loading state: show "Entering..." with spinner when connecting
      - On click: initialize spatialAudio, connectSocket(), joinGame() (same logic as current)

   f. **Logout Link:**
      - Below the button: text-gray-500 text-sm hover:text-white cursor-pointer
      - Calls logout() then setAuthUser(null)

   **Important:** Import spatialAudio from services/spatialAudio and handle the initialization just like the current Lobby does (initialize + resume on user gesture).
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - `client/src/animations/transitions.ts` exports fadeScaleVariants and zoomInVariants
    - `client/src/components/Lobby.tsx` exports Lobby component
    - Lobby.tsx imports Card, Button, Badge, GradientBackground
    - Lobby.tsx has socket listener for online count
    - Lobby.tsx has gradient avatar circle with first letter
  </verify>
  <done>
    - AUTH-07: Polished lobby with gradient avatar, username, "Ready to explore?" tagline, live online count badge, prominent enter space button
    - Transition variants defined for fade/scale and zoom-in
    - Lobby component fully standalone with all imports
  </done>
</task>

<task type="auto">
  <name>Task 2: Rewrite App.tsx with AnimatePresence transitions and skeleton loading</name>
  <files>client/src/App.tsx</files>
  <action>
Rewrite `client/src/App.tsx` to add animated page transitions and skeleton loading:

**Imports to add:**
- motion, AnimatePresence from 'framer-motion'
- fadeScaleVariants, zoomInVariants from '../animations/transitions'
- Lobby from './components/Lobby' (now a standalone component, remove inline Lobby)
- Card from './components/ui/Card'
- ToastProvider from './components/ui/Toast'

**Remove:**
- The inline Lobby function (now in separate file)
- Keep VoiceControls inline (it's game-specific, not auth/lobby related)

**Skeleton Loading Component (inline in App.tsx):**
Create a `SessionSkeleton` component that shows during session restore:
- GradientBackground behind it
- Centered glassmorphism Card with animated shimmer placeholders:
  - A circular skeleton (w-16 h-16 rounded-full bg-surface-700 animate-pulse) for avatar
  - A rectangular skeleton (w-32 h-4 bg-surface-700 animate-pulse rounded) for username
  - Two rectangular skeletons (w-full h-10 bg-surface-700 animate-pulse rounded-lg) for buttons
- Use the existing Tailwind animate-pulse for shimmer (no new library needed -- skip react-loading-skeleton to avoid unnecessary dependency)
- Add minimum 300ms display time: track both `restoring` state AND a `minTimeElapsed` state. Set minTimeElapsed=true after 300ms setTimeout. Only hide skeleton when BOTH are true.

**App Component Rewrite:**
```tsx
export function App() {
  const isAuthenticated = useGameStore((s) => s.isAuthenticated);
  const joined = useGameStore((s) => s.joined);
  const [restoring, setRestoring] = useState(true);
  const [minTimeElapsed, setMinTimeElapsed] = useState(false);

  // Minimum skeleton display time (300ms)
  useEffect(() => {
    const timer = setTimeout(() => setMinTimeElapsed(true), 300);
    return () => clearTimeout(timer);
  }, []);

  // Auto-restore session (keep existing logic)
  useEffect(() => { /* same as current */ }, []);

  // Cleanup on unmount (keep existing logic)
  useEffect(() => { /* same as current */ }, []);

  const showSkeleton = restoring || !minTimeElapsed;

  // Determine current page key for AnimatePresence
  const pageKey = showSkeleton ? 'skeleton' : !isAuthenticated ? 'auth' : !joined ? 'lobby' : 'game';

  return (
    <>
      <ToastProvider />
      <AnimatePresence mode="wait">
        {pageKey === 'skeleton' && (
          <motion.div key="skeleton" variants={fadeScaleVariants} initial="initial" animate="animate" exit="exit" className="w-screen h-screen">
            <SessionSkeleton />
          </motion.div>
        )}
        {pageKey === 'auth' && (
          <motion.div key="auth" variants={fadeScaleVariants} initial="initial" animate="animate" exit="exit" className="w-screen h-screen">
            <AuthForms />
          </motion.div>
        )}
        {pageKey === 'lobby' && (
          <motion.div key="lobby" variants={fadeScaleVariants} initial="initial" animate="animate" exit="exit" className="w-screen h-screen">
            <Lobby />
          </motion.div>
        )}
        {pageKey === 'game' && (
          <motion.div key="game" variants={zoomInVariants} initial="initial" animate="animate" exit="exit" className="w-screen h-screen relative">
            <Canvas />
            <VoiceControls />
          </motion.div>
        )}
      </AnimatePresence>
    </>
  );
}
```

**Key details:**
- AnimatePresence mode="wait" ensures exit animation finishes before enter begins
- skeleton -> auth: fade/scale transition
- auth -> lobby: fade/scale transition (same card style, smooth)
- lobby -> game: zoom-in transition (dramatic entrance to game world)
- game gets its own zoom-in variant for the immersive "entering the space" feel
- ToastProvider is OUTSIDE AnimatePresence so toasts persist across transitions
- The 300ms minimum skeleton display prevents flash-of-skeleton on fast connections
- PixiJS Canvas is NOT initialized until the game page renders (lazy init per research recommendation)
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - App.tsx imports and uses AnimatePresence from framer-motion
    - App.tsx imports fadeScaleVariants and zoomInVariants
    - App.tsx has SessionSkeleton with 300ms minimum display time
    - App.tsx renders ToastProvider outside AnimatePresence
    - App.tsx uses motion.div with variants for all 4 page states
    - App.tsx no longer has inline Lobby component (imports from ./components/Lobby)
    - VoiceControls still renders in game view
  </verify>
  <done>
    - AUTH-08: Smooth transitions -- fade/scale auth to lobby, zoom-in lobby to space, skeleton loading for session restore
    - AnimatePresence with mode="wait" ensures clean transition lifecycle
    - Skeleton loading shows 300ms minimum, prevents flash
    - ToastProvider persists across page transitions
    - PixiJS lazy-initialized on game page (not on lobby load)
    - All existing functionality preserved (VoiceControls, socket, spatial audio)
  </done>
</task>

</tasks>

<verification>
1. Run `npx tsc --noEmit` -- no TypeScript errors
2. App.tsx uses AnimatePresence wrapping all page states with proper motion variants
3. Skeleton loading shows for minimum 300ms with gradient background and shimmer placeholders
4. Auth page fades/scales into lobby on successful login
5. Lobby zooms into game space on "Enter Space" click
6. Lobby shows gradient avatar, username, tagline, online count, enter button
7. ToastProvider renders above all pages for persistent notifications
8. VoiceControls still functional in game view
</verification>

<success_criteria>
- Lobby.tsx is a standalone polished component with gradient avatar, live online count, enter space button
- transitions.ts exports reusable fadeScaleVariants and zoomInVariants
- App.tsx uses AnimatePresence for all page transitions
- Skeleton loading with 300ms minimum display replaces "Loading..." text
- All transitions smooth and cinematic
- AUTH-07 and AUTH-08 requirements fully addressed
- TypeScript compiles without errors
- No regressions to existing game functionality
</success_criteria>

<output>
After completion, create `.planning/phases/02-authentication-lobby-redesign/02-03-SUMMARY.md`
</output>
